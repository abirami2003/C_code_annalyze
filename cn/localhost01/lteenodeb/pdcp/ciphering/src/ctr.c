/******************************************************************************
 *
 *  ARICENT -
 *
 *  Copyright (C) 2010 Aricent Inc. All Rights Reserved.
 *
 *****************************************************************************
 *
 *  $Id: ctr.c,v 1.1 2010/06/10 09:38:13 gur21010 Exp $
 *
 ****************************************************************************
 *
 * File Description : Functions to convert AES (EEA2) algorithm into counter mode  
 ****************************************************************************
 *
 * Revision Details
 * ----------------
 *
 *
 ****************************************************************************/

/****************************************************************************
 * Standard Library Includes
 *****************************************************************************/

/******************************************************************************
 * Project Includes
 *****************************************************************************/
#include "scrypt.h"

/******************************************************************************
  Private Definitions
 *****************************************************************************/

/******************************************************************************
  Private Types
 *****************************************************************************/

/*****************************************************************************
 * Private Function Prototypes
 ****************************************************************************/

/******************************************************************************
 * Private Constants
 *****************************************************************************/

/******************************************************************************
 * Exported Variables
 *****************************************************************************/

/*****************************************************************************
 * Private Variables (Must be declared static)
 *****************************************************************************/

/****************************************************************************
 * Functions implementation 
 ****************************************************************************/

void __core_ctr_start( 
     const union key_u *U, 
     struct __ctr_s *Q, 
     const UInt8 *salt, 
     UInt32 countersize )
{
	Q->n = 0;
	Q->countersize = countersize;

	memCpy( Q->counter, salt, 16 );
	aes128_encrypt( U, Q->counter, Q->keystream );
}

void __core_ctr( const union key_u *U, struct __ctr_s *Q,  
		const UInt8 *input, UInt8 *output, UInt32 L )
{
	UInt32 i, n = Q->n, blocksize = 16, countersize = Q->countersize;

	while( L ) {
		*output = *input ^ Q->keystream[n];

		output++;
		input++;
		n++;
		L--;

		if( n == blocksize ) {
			for(i = 0; i<countersize; i++) {
				if( ++Q->counter[blocksize - 1 - i] != 0 ) {
					break;
				}
			}

			aes128_encrypt( U, Q->counter, Q->keystream );
			n = 0;
		}
	}
	
	Q->n = n;
}

void ctr_start( struct ctr_s *Q, 
                const UInt8 *key, 
                const UInt8 *salt, 
                UInt32 countersize )
{
	aes128_setup( &Q->key, key );

	__core_ctr_start( &Q->key, &Q->state, salt, countersize );
}

void __ctr( struct ctr_s *Q,  const UInt8 *input, UInt8 *output, UInt32 L )
{
	__core_ctr( &Q->key, &Q->state, input, output, L );
}
